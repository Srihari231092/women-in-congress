<!DOCTYPE html>
<meta charset="utf-8">
<style>
    svg {
        font: 20px sans-serif;
    }

    p {
        margin: 6px 2px;
    }

    .axisTitle {
        font: bold 12px sans-serif;
    }

    .x.axis .domain {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .d3-tip {
        line-height: 1;
        font-weight: bold;
        padding: 8px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        border-radius: 2px;
        font: 14px sans-serif;
    }
    /* Creates a small triangle extender for the tooltip */

    .d3-tip:after {
        box-sizing: border-box;
        display: inline;
        font-size: 10px;
        width: 100%;
        line-height: 1;
        color: rgba(0, 0, 0, 0.8);
        content: "\25BC";
        position: absolute;
        text-align: center;
    }
    /* Style northward tooltips differently */

    .d3-tip.n:after {
        margin: -1px 0 0 0;
        top: 100%;
        left: 0;
    }
</style>

<body>
    <script src="http://localhost:35730/livereload.js"></script>
    <script src="external/d3.v4.min.js"></script>
    <script src="external/d3-tip.js"></script>
    <script>
        var margin = {
                top: 50,
                right: 50,
                bottom: 50,
                left: 50
            },
            width = 300 - margin.left - margin.right,
            height = 800 - margin.top - margin.bottom,

            padding = 2,
            maxRadius = 30,
            minRadius = 2;

        var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .attr("shape-rendering", "geometric-precision");

        var wrapper = svg
            .append("g")
            .attr("class", "wrapper")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var topics = ['european union', 'nhs',
            'welfare reforms', 'education',
            'middle east', 'armed forces',
            'domestic violence', 'child care', 'energy'
        ]
        var topics = ["welfare reforms"]
        var topics = ["Male", "Female"]
        var x = d3.scalePoint()
            .domain(topics)
            .range([0 + width / 4, width * 3 / 4]);

        var xAxis = d3.axisBottom(x);
        var y = d3.scaleLinear()
            .domain([0, 0.3])
            .range([height, 0]);

        var yAxis = d3.axisLeft(y);

        var tip = d3.tip()
            .attr('class', 'd3-tip')
            .offset([-6, 0])
            .html(function(d) {
                return `<p><strong> ${d.full_name} </strong></p>
    <p>${d[topic_name]}</p><p>
    </p>`;
            });

        svg.call(tip);


        var xAxisTitle = svg.append("text")
            .attr("class", "axisTitle")
            .text("Topic")

        xAxisTitle
            .attr("x", width - xAxisTitle.node().getBBox().width + margin.right)
            .attr("y", margin.top + (height / 2) - xAxisTitle.node().getBBox().height);

        wrapper.append("text")
            .attr("x", 50)
            .attr("y", 30)
            .attr("dy", "0.71em")
            .text("What topics are MPs interested in?");


        d3.csv("data.csv" + '?' + Math.floor(Math.random() * 1000), function(error, data) {
            if (error) throw error;

            // Convert wide data to long
            nodes = data.map(function(d) {
                node = {
                    "full_name": d.full_name,
                    "party": d.Party,
                    "gender": d.is_female == 1 ? "Female" : "Male"
                };
                Object.keys(d).forEach(function(key) {
                    if (key != "full_name" & key != "Party" & key != "is_female") {
                        node[key] = d[key] == '-inf' ? 0 : 10 ** (+d[key])
                    }
                })
                return node
            })
            // data.forEach(function(row) {
            //     // Loop through all of the columns, and for each column
            //     // make a new row
            //     Object.keys(row).forEach(function(colname) {
            //         // Ignore 'State' and 'Value' columns
            //         if (colname == "full_name" || colname == "is_female" || colname == "Party") {
            //             return
            //         }
            //         nodes.push({
            //             "full_name": row["full_name"],
            //             "gender": row["is_female"] == 1 ? "Female" : "Male",
            //             "party": row["Party"],
            //             "value": row[colname] == '-inf' ? 0 : 10 ** (+row[colname]),
            //             "topic_name": colname
            //         });
            //     });
            // });

            // nodes = nodes.filter(node => ["welfare reforms"].indexOf(node.topic_name) >= 0)
            topic_name = "welfare reforms";
            // var colorScale = d3.scaleSequential(d3.interpolateRainbow).domain([0, 0.05]);
            var colorScale = d3.scaleQuantize().domain([0, 0.1]).range(d3.schemeCategory20);
            var colorScale = d3.scaleOrdinal(d3.schemeCategory10)
            .domain(["Male", "Female"])
            var colorScale = d3.scaleOrdinal(d3.schemeCategory10)
                .domain(["Labour", "Conservative", "Liberal Democrat", "Scottish National Party"])

            var simulation = d3.forceSimulation(nodes)
                .force("x", d3.forceX(function(d) {
                    return x(d.gender);
                }).strength(0.1))
                .force("collide", d3.forceCollide(1.0).radius(2).iterations(10))

            nodes.map(function(d) {
                d.x = x(d.gender)
                node_y = y(d[topic_name])
                d.y = Math.min(node_y + 2.5, Math.max(node_y - 2.5, d.y))
            })

            var circle = wrapper.selectAll("circle")
                .data(nodes)
                .enter().append("circle")
                .style("fill", function(d) {
                    return d.gender == "Male" ? "red" : "blue";
                    // return colorScale(d.party);
                })
                .attr("r", 1.8)
                .style("opacity", 0.7)
                .on('mouseover', tip.show)
                .on('mouseout', tip.hide)

            simulation.on("tick", function() {
                nodes.map(function(d) {
                    node_y = y(d[topic_name])
                    d.y = Math.min(node_y + 2.5, Math.max(node_y - 2.5, d.y))
                })
                circle.attr("cx", function(d) {
                        return d.x
                    })
                    .attr("cy", function(d) {
                        // return Math.max(0 + 2.5, Math.min(height - 2.5, d.y))
                        return d.y
                    })
            })
            //  .stop();

            // for (var i = 0; i < 300; ++i) simulation.tick()


        });
        wrapper.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);
    </script>
</body>

</html>
