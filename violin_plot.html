<!doctype html>
<html>

    <head>
        <title>Violin plot</title>
        <style>
            svg {
                font: 20px sans-serif;
            }

            p {
                margin: 6px 2px;
            }

            .axisTitle {
                font: bold 12px sans-serif;
            }

            .x.axis .domain {
                fill: none;
                stroke: #000;
                shape-rendering: crispEdges;
            }
        </style>
    </head>

    <body>
        <script src="external/d3.v4.min.js"></script>
        <script src="external/d3-tip.js"></script>
        <script>
            var margin = {
                    top: 50,
                    right: 50,
                    bottom: 50,
                    left: 50
                },
                width = 4000 - margin.left - margin.right,
                height = 1000 - margin.top - margin.bottom;

            function kernelDensityEstimator(kernel, X) {
                return function(V) {
                    return X.map(function(x) {
                        return [x, d3.mean(V, function(v) {
                            return kernel(x - v);
                        })];
                    });
                };
            }

            function kernelEpanechnikov(k) {
                return function(v) {
                    return Math.abs(v /= k) <= 1 ? 0.75 * (1 - v * v) / k : 0;
                };
            }

            var svg = d3.select("body").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .attr("shape-rendering", "geometric-precision");

            d3.csv("data.csv" + '?' + Math.floor(Math.random() * 1000), function(error, data) {
                if (error) throw error;

                nodes = data.map(function(d) {
                    return {
                        "topic_id": d.topic_id,
                        "topic_name": d.topic_name,
                        "value": +d.value,
                        "full_name": d.full_name,
                        "party": d.Party,
                        "gender": d.is_female == "True" ? "Female" : "Male"
                    };
                })


                // Group MPs by topic and gender
                nodes = d3.nest()
                    .key(function(d) {
                        return d.party;
                    })
                    .key(function(d) {
                        return d.topic_name;
                    })
                    .key(function(d) {
                        return d.gender;
                    })
                    .entries(nodes)

                // Number of topics
                n_topics = nodes[0].values.length
                n_parties = nodes.length

                x_topics = d3.scaleBand()
                    .domain(nodes[0].values.map(function(d) {
                        return d.key
                    }))
                    .range([0, width])
                    .paddingOuter(0.1)
                    .paddingInner(0.1);

                y_parties = d3.scaleBand()
                    .domain(nodes.map(function(d) {
                        return d.key
                    }))
                    .range([0, height])
                    .paddingOuter(0.0)
                    .paddingInner(0.1);

                var wrapper = svg
                    .append("g")
                    .attr("class", "wrapper")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                // One group per party
                var party_wrappers = wrapper
                    .selectAll(".party-wrapper")
                    .data(nodes)
                    .enter()
                    .append("g")
                    .attr("class", "party-wrapper")
                    .attr("transform", function(g) {
                        return `translate(0, ${y_parties(g.key)})`
                    })

                // One group per topic
                var violin_wrappers = party_wrappers
                    .selectAll(".violin-wrapper")
                    .data(function(d) {
                        return d.values
                    })
                    .enter()
                    .append("g")
                    .attr("class", "violin-wrapper")
                    .attr("transform", function(g) {
                        return `translate(${x_topics(g.key)}, 0)`
                    })

                var x_violin = d3.scaleLinear()
                    .domain([-0.5, 0.5])
                    .range([0, x_topics.bandwidth()]);

                var y_violin = d3.scaleLinear()
                    .domain([-0.05, 0.5])
                    .range([y_parties.bandwidth(), 0]);

                var yAxis = d3.axisLeft(y_violin)
                .ticks(5);

                var y_violin_axis = party_wrappers.append("g")
                    .attr("class", "axis axis--y")
                    .call(yAxis)
                var violin_area = d3.area()
                    .curve(d3.curveCardinal)
                    .x0(function(d) {
                        if((d[0][1]/100) > 0.01) {
                            return x_violin(0);
} else {return x_violin(0);}
                    })
                    .x1(function(d) {
                        if((d[0][1]/100) > 0.01) {
                        return x_violin((d[1] == "Male" ? -1 : 1) * d[0][1] / 100);
} else {return x_violin(0) ;}
                    })
                    .y(function(d) {
                        if(d[0][0] == -0.05) {
                            last_value = 0
                        }
                        if((d[0][1]/100) > 0.01) {
                            last_value = d[0][0];
                        return y_violin(d[0][0]);
                    } else {  return y_violin(last_value)}
                    })

                violin_wrappers
                    .selectAll(".topic-curve")
                    .data(function(d) {
                        return d.values
                    })
                    .enter()
                    .append("path")
                    .attr("class", function(d) {
                        return "topic-curve topic-curve-" + d.key
                    })
                    .attr("fill", function(d) {
                        return d.key == "Female" ? "orange" : "blue"
                    })
                    .attr("stroke", "black")
                    .attr("stroke-width", 1)
                    .attr("d", function(d) {
                        kde = kernelDensityEstimator(kernelEpanechnikov(0.01), y_violin.ticks(500))
                        data = kde(d.values.map(function(x) {
                            return x.value;
                        })).map(
                            function(c) {
                                return [c, d.key]
                            }
                        )
                        return violin_area(data)
                    });
            });
        </script>
    </body>

</html>
