<!doctype html>
<html>

    <head>
        <title>Violin plot</title>
        <style>
            svg {
                font: 20px sans-serif;
            }

            p {
                margin: 6px 2px;
            }

            .axisTitle {
                font: bold 12px sans-serif;
            }

            .x.axis .domain {
                fill: none;
                stroke: #000;
                shape-rendering: crispEdges;
            }
        </style>
    </head>

    <body>
        <script src="external/d3.v4.min.js"></script>
        <script src="external/d3-tip.js"></script>
        <script>
            var margin = {
                    top: 50,
                    right: 50,
                    bottom: 50,
                    left: 50
                },
                width = 6000 - margin.left - margin.right,
                height = 1000 - margin.top - margin.bottom;

            function kernelDensityEstimator(kernel, X) {
                return function(V) {
                    return X.map(function(x) {
                        return [x, d3.mean(V, function(v) {
                            return kernel(x - v);
                        })];
                    });
                };
            }

            function kernelEpanechnikov(k) {
                return function(v) {
                    return Math.abs(v /= k) <= 1 ? 0.75 * (1 - v * v) / k : 0;
                };
            }

            var svg = d3.select("body").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .attr("shape-rendering", "geometric-precision");

            d3.csv("data.csv" + '?' + Math.floor(Math.random() * 1000), function(error, data) {
                if (error) throw error;

                nodes = data.map(function(d) {
                    return {
                        "topic_id": d.topic_id,
                        "topic_name": d.topic_name,
                        "value": +d.value,
                        "full_name": d.full_name,
                        "party": d.Party,
                        "gender": d.is_female == "True" ? "Female" : "Male"
                    };
                })


                // Group MPs by topic and gender
                nodes = d3.nest()
                    .key(function(d) {
                        return d.party;
                    })
                    .key(function(d) {
                        return d.topic_name;
                    })
                    .key(function(d) {
                        return d.gender;
                    })
                    .entries(nodes)

                // Number of topics
                n_topics = nodes[0].values.length
                n_parties = nodes.length

                x_topics = d3.scaleBand()
                    .domain(nodes[0].values.map(function(d) {
                        return d.key
                    }))
                    .range([0, width])
                    .paddingOuter(0.1)
                    .paddingInner(0.0);

                y_parties = d3.scaleBand()
                    .domain(nodes.map(function(d) {
                        return d.key
                    }))
                    .range([0, height])
                    .paddingOuter(0.1)
                    .paddingInner(0.1);

                var wrapper = svg
                    .append("g")
                    .attr("class", "wrapper")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                // One group per party
                var party_wrappers = wrapper
                    .selectAll(".party-wrapper")
                    .data(nodes)
                    .enter()
                    .append("g")
                    .attr("class", "party-wrapper")
                    .attr("transform", function(g) {
                        return `translate(0, ${y_parties(g.key)})`
                    })

                // One group per topic
                var violin_wrappers = party_wrappers
                    .selectAll(".violin-wrapper")
                    .data(function(d) {
                        return d.values
                    })
                    .enter()
                    .append("g")
                    .attr("class", "violin-wrapper")
                    .attr("transform", function(g) {
                        return `translate(${x_topics(g.key)}, 0)`
                    })

                var x_violin = d3.scaleLinear()
                    .domain([-0.6, 0.6])
                    .range([0, x_topics.bandwidth()]);

                var y_violin = d3.scaleLinear()
                    .domain([-0.0, 0.301])
                    .range([y_parties.bandwidth(), 0]);

                var x_topic_axis = wrapper.append("g")
                    .attr("class", "axis axis--x")
                    .attr("transform", `translate(0, ${height})`)
                    .call(d3.axisBottom(x_topics))
                    .selectAll("text")
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(-30)");


                var y_violin_axis = party_wrappers.append("g")
                    .attr("class", "axis axis--y")
                    .call(d3.axisLeft(y_violin).ticks(4))

                var violin_area = d3.area()
                    .curve(d3.curveCardinal)
                    .x0(function(d) {
                        return x_violin(0);
                    })
                    .x1(function(d) {
                        return x_violin((d[1] == "Male" ? -1 : 1) * d[0][1] / 100);
                    })
                    .y(function(d) {
                        return y_violin(d[0][0]);
                    })

                violin_wrappers
                    .selectAll(".topic-curve")
                    .data(function(d) {
                        return d.values
                    })
                    .enter()
                    .append("path")
                    .attr("class", function(d) {
                        return "topic-curve topic-curve-" + d.key
                    })
                    .attr("fill", function(d) {
                        return d.key == "Female" ? "orange" : "blue"
                    })
                    .attr("stroke", "black")
                    .attr("stroke-width", 0.5)
                    .attr("d", function(d) {
                        kde = kernelDensityEstimator(kernelEpanechnikov(0.01), y_violin.ticks(50))

                        data = kde(d.values.map(function(x) {
                                return x.value;
                            }))
                            .reverse() // Return the reverse of the array so that it goes from top to bottom

                        // filter all data points that have too small a bandwidth

                        // first get the maximum y value that we want to plot by filtering
                        // any points that have more than 1% width and then selecting the largest y value
                        max_y = data
                            .filter(function(x) {
                                return x[1] > 1.0
                            })[0][0]
                        // then filter all points with a y less than max_y
                        // and add the gender key to the data
                        data = data
                            .filter(function(x) {
                                return x[0] <= max_y
                            })
                            .map(
                                function(c) {
                                    return [c, d.key]
                                }
                            )

                        return violin_area(data)
                    })
            });
        </script>
    </body>

</html>
