<!DOCTYPE html>
<meta charset="utf-8">
<style>
    body {
        color: #ccc;
        background-color: #171717;
    }

    svg {
        font: 20px sans-serif;
    }

    text {
        fill: #ccc;
    }

    p {
        margin: 6px 2px;
    }

    .axisTitle {
        font: bold 12px sans-serif;
    }

    .x.axis .domain {
        fill: none;
        stroke: #ccc;
        shape-rendering: crispEdges;
    }

    .d3-tip {
        line-height: 1;
        font-weight: bold;
        padding: 8px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        border-radius: 2px;
        font: 14px sans-serif;
    }
    /* Creates a small triangle extender for the tooltip */

    .d3-tip:after {
        box-sizing: border-box;
        display: inline;
        font-size: 10px;
        width: 100%;
        line-height: 1;
        color: rgba(0, 0, 0, 0.8);
        content: "\25BC";
        position: absolute;
        text-align: center;
    }
    /* Style northward tooltips differently */

    .d3-tip.n:after {
        margin: -1px 0 0 0;
        top: 100%;
        left: 0;
    }
</style>

<body>
    <script src="http://localhost:35730/livereload.js"></script>
    <script src="external/d3.v4.min.js"></script>
    <script src="external/d3-tip.js"></script>
    <script>
        var margin = {
                top: 50,
                right: 50,
                bottom: 50,
                left: 50
            },
            width = 800 - margin.left - margin.right,
            height = 800 - margin.top - margin.bottom,

            padding = 2,
            maxRadius = 30,
            minRadius = 2;

        var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .attr("shape-rendering", "geometric-precision");

        var wrapper = svg
            .append("g")
            .attr("class", "wrapper")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            topic_name = "european union";
        var topics = [topic_name]
        // var topics = ["Male", "Female"]
        var x = d3.scalePoint()
            .domain(topics)
            .range([0 + width / 4, width * 3 / 4]);

        var xAxis = d3.axisBottom(x);
        var y = d3.scaleLinear()
            .domain([0, 0.3])
            .range([height, 0]);

        var yAxis = d3.axisLeft(y);

        var tip = d3.tip()
            .attr('class', 'd3-tip')
            .offset([-6, 0])
            .html(function(d) {
                return `<p><strong> ${d.full_name} </strong></p>
    <p>${d[topic_name]}</p><p>
    </p>`;
            });

        svg.call(tip);


        var xAxisTitle = svg.append("text")
            .attr("class", "axisTitle")
            .text("Topic")

        xAxisTitle
            .attr("x", width - xAxisTitle.node().getBBox().width + margin.right)
            .attr("y", margin.top + (height / 2) - xAxisTitle.node().getBBox().height);

        wrapper.append("text")
            .attr("x", 50)
            .attr("y", 30)
            .attr("dy", "0.71em")
            .text("What topics are MPs interested in?");

        baked_positions = [];
        d3.csv("baked_positions.csv" + "?" + Math.floor(Math.random() * 1000), function(d) {
            d.id = +d.id;
            d.x = +d.x;
            d.y = +d.y;
            return d
        },
        function(error, data) {
            if(error) throw error;
baked_positions = data;

        })
        d3.csv("data.csv" + '?' + Math.floor(Math.random() * 1000), function(error, data) {
            if (error) throw error;

            // Convert wide data to long
            nodes = data.map(function(d) {
                node = {
                    "id":+d.id,
                    "full_name": d.full_name,
                    "party": d.Party,
                    "gender": d.is_female == 1 ? "Female" : "Male",
                };
                Object.keys(d).forEach(function(key) {
                    if (key != "id" & key != "full_name" & key != "Party" & key != "is_female") {
                        node[key] = d[key] == '-inf' ? 0 : 10 ** (+d[key])
                    }
                })
                return node
            })

            // nodes = nodes.filter(node => ["welfare reforms"].indexOf(node.topic_name) >= 0)
            var colorScale = d3.scaleOrdinal(d3.schemeCategory10)
                .domain(["Labour", "Conservative", "Liberal Democrat", "Scottish National Party"])

            var  nodes_male = nodes.filter(d => d.gender == "Male");
            var  nodes_female = nodes.filter(d => d.gender != "Male");

            simulation_male = d3.forceSimulation(nodes_male)
                .force("x", d3.forceX(function(d) {
                    return x(topic_name);
                }).strength(0.1))
                .force("collide",
                    d3.forceCollide(10.0)
                    .radius(2)
                    .iterations(30))
                .alphaMin(0.000000001)
                .velocityDecay(0.1)

            simulation_female = d3.forceSimulation(nodes_female)
                .force("x", d3.forceX(function(d) {
                    return x(topic_name);
                }).strength(0.1))
                .force("collide",
                    d3.forceCollide(7.0)
                    .radius(2)
                    .iterations(10))
                .alphaMin(0.000001)
                .velocityDecay(0.2)

            // Set default positions for nodes
            function getRandomInt(min, max) {
                min = Math.ceil(min);
                max = Math.floor(max);
                return Math.floor(Math.random() * (max - min)) + min; //The maximum is exclusive and the minimum is inclusive
            }
            nodes_male.map(function(d) {
                n = baked_positions.filter(n => n.id == d.id)[0]
                d.x = n.x * 2.5 + x(topic_name)
                d.y = y(n.y)
            })
            nodes_female.map(function(d) {
                n = baked_positions.filter(n => n.id == d.id)[0]
                d.x = n.x * 2.5 + x(topic_name)
                d.y = y(n.y)
            })

            var circle_male = wrapper.selectAll(".male-node")
                .data(nodes_male)
                .enter().append("circle").attr("class", "male-node")
                .style("fill", function(d) {
                    return d.gender == "Male" ? "red" : "blue";
                    // return colorScale(d.party);
                })
.attr("cx", function(d) {
                        return d.x
                    })
                    .attr("cy", function(d) {
                        // return Math.max(0 + 2.5, Math.min(height - 2.5, d.y))
                        return d.y
                    })
                .attr("r", 1.8)
                .style("opacity", 0.7)
                .on('mouseover', tip.show)
                .on('mouseout', tip.hide)

            simulation_male.on("tick", function() {
                nodes_male.map(function(d) {
                    d.x = Math.min(d.x, x(topic_name) - 2.5)
                    node_y = y(d[topic_name])
                    d.y = Math.min(node_y + 5, Math.max(node_y - 5, d.y))
                })
                circle_male.attr("cx", function(d) {
                        return d.x
                    })
                    .attr("cy", function(d) {
                        // return Math.max(0 + 2.5, Math.min(height - 2.5, d.y))
                        return d.y
                    })
            }).stop()

            var circle_female  = wrapper.selectAll(".female-node")
                .data(nodes_female)
                .enter().append("circle").attr("class", "female-node")
                .style("fill", function(d) {
                    return d.gender == "Male" ? "red" : "blue";
                    // return colorScale(d.party);
                })
.attr("cx", function(d) {
                        return d.x
                    })
                    .attr("cy", function(d) {
                        // return Math.max(0 + 2.5, Math.min(height - 2.5, d.y))
                        return d.y
                    })
                .attr("r", 1.8)
                .style("opacity", 0.7)
                .on('mouseover', tip.show)
                .on('mouseout', tip.hide)

            simulation_female.on("tick", function() {
                nodes_female.map(function(d) {
                    d.x =  Math.max(x(topic_name) + 2.5, d.x)
                    node_y = y(d[topic_name])
                    d.y = Math.min(node_y + 2.5, Math.max(node_y - 2.5, d.y))
                })
                circle_female.attr("cx", function(d) {
                        return d.x
                    })
                    .attr("cy", function(d) {
                        // return Math.max(0 + 2.5, Math.min(height - 2.5, d.y))
                        return d.y
                    })
            })
             .stop();

            // for (var i = 0; i < 300; ++i) simulation.tick()


        });
        wrapper.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);
    </script>
</body>

</html>
